/*!
 * 
 * jquery.area2select
 * 
 * @license	无限，男女老少皆宜
 * @version 1.0.0
 * @author  咖啡兔
 * @site    www.wsria.com
 */
(function($){$.fn.area2select=function(settings){var _this=this;function getCtx(){var url=location.pathname;var contextPath=url.substr(0,url.indexOf('/',1));return contextPath};var defaults={url:getCtx()+'/bdata/area-info!findArea.action',fromHtmlUrl:getCtx()+'/bdata/area-info!htmlCode.action',topLevel:1,defaultValue:null,parentName:null,layer:null,attrs:{},callback:null};settings=$.extend(true,defaults,settings);function _plugin_init(){if($.isFunction(settings.defaultValue)){settings.defaultValue=settings.defaultValue()}if(settings.parentName){settings.parentName=encodeURIComponent(settings.parentName)}};_plugin_init();function setDefaultValue(){if(settings.defaultValue){$(_this).html('&nbsp;').addClass('loading').load(settings.fromHtmlUrl,{childId:settings.defaultValue},function(){$('select',_this).attr(settings.attrs).bind('change',function(){if(settings.layer>$('.area2select',_this).length){loadChilds(this,true)}}).addClass('area2select');if($.isFunction(settings.callback)){settings.callback()}})}};function loadChilds(selem,manual){if(settings.layer){if($.isFunction(settings.callback)){settings.callback()}if(settings.layer==$('.area2select',_this).length){$('select:not(:last)',_this).unbind('change').bind('change',function(){loadChilds(this,true);return});if(!manual){return}}};$(selem).nextAll().remove();$('<span/>',{html:'&nbsp;&nbsp;'}).addClass('loading').appendTo(_this);$.getJSON(settings.url,{parentId:parseInt($(selem).val())},function(areas){$('.loading',_this).remove();if(areas.length==0){if($.isFunction(settings.callback)){settings.callback()}return}var _level=$('select',_this).length+1;var $select=$('<select/>').addClass('area2select').data('level',_level).bind('change',function(){loadChilds(this,false)});$.each(areas,function(i,n){$('<option/>',{value:n.id,text:n.areaName}).appendTo($select)});$(_this).append($select);$select.attr(settings.attrs).trigger('change')})};return this.each(function(){if(settings.defaultValue){setDefaultValue()}else{$('.area2select',_this).remove();$('<span/>',{html:'&nbsp;&nbsp;'}).addClass('loading').appendTo(_this);if($('select',this).length==0){$(this).data('first',true)}var _param={};if(settings.parentName){_param.parentName=settings.parentName}else{_param.level=settings.topLevel}$.getJSON(settings.url,_param,function(areas){$('.loading',_this).remove();var $select=$('<select/>').addClass('area2select').data('level',settings.topLevel).bind('change',function(){loadChilds(this,false)});$.each(areas,function(i,n){$('<option/>',{value:n.id,text:n.areaName}).appendTo($select)});$(_this).append($select);$select.attr(settings.attrs).trigger('change')})}})};$.fn.getAreaId=function(index){if(index){var _select=$('select:eq('+(parseInt(index)-1)+')',this);return{text:_select.find('option:selected').text(),value:_select.val()}}var _select=$('select:last',this);return{text:_select.find('option:selected').text(),value:_select.val()}}})(jQuery);